<!doctype html>
<html>
<head>
    <title>Issuing</title>
    </head>
    <h1>Issue a Credential</h1>
    <body>
        <div class="w3-container">
        <p>Create Schema</p>
        <form id="schema_form">
            <div>
                <label for="schema_name">Schema Name: </label>
                <input type="text" id="schema_name" name="schema_name"><br><br>
            </div>
            <div>
                <label for="schema_name">Schema Version: </label>
                <input type="text" id="schema_version" name="schema_version"><br><br>
            </div>
            <div>
                <label for="attributes">Please input a JSON array of attributes:</label>
                <textarea id="attributes" name="attributes" rows="10" cols="20">
                    ["public_key","vin"]
                </textarea>
                <br><br>
            </div>
            <button class="submit" name="Submit" value="Submit">Submit</button>
        </form>
        </div>
        <div class="w3-container">
        <p>Create Credential Definition</p>
        <form action="/credential-definitions" method="POST">
            <div>
            <label for="schemas">Schema ID:</label>
            <select name="schemas" method="GET" action="/">
                {% for schema in schemas %}
                    <option value="{{schema}}" SELECTED>{{schema}}</option>
                {% endfor %}
            </select>
            </div>
            <div>
                <label for="connections">Recipient DID:</label>
                <select name="connections" method="GET" action="/">
                    {% for connection, value in connections.items() %}
                        <option value="{{value}}" SELECTED>{{connection}}</option>
                    {% endfor %}
                </select>
                </div>
            <button class="button execute" name="Submit" value="Submit">Submit</button>
        </form>
        </div>
    </body>
    <script>

        const schemaForm = document.getElementById('schema_form');
        
        //turn JSON array in form data into a usable Array for the API POST
        function handleAttributes(formString,arrayString) {
            var attributesData = document.getElementById(formString).elements[arrayString].innerHTML;
            var attributesArray = attributesData.split("[").join("").split("]").join("").split("\n").join("").split(",");
            handledArray = [];
            for(let attr of attributesArray){
                handledArray.push(attr);
            }
            return handledArray;
        }
    
        schemaForm.addEventListener('submit', function(e) {
            e.preventDefault();
    
            //create formData variable
            const formData = new FormData(this);
    
            //handle the JSON array of attributes
            function handleArrayInForm(form,arrayStringName) {
                var attributesData = form.get(arrayStringName);
                var attributesArray = attributesData.split("[").join("").split("]").join("").split("\n").join("").split(",");
                handledArray = [];
                for(let attr of attributesArray){
                    handledArray.push(attr);
            }
            return handledArray;
        }
            //attributesArray = formData.get('attributes');
    
            const schemaBody = {};
    
            for(var pair of formData.entries()) {
                if(pair[0] != "attributes") {
                    schemaBody[pair[0]] = pair[1];
                } 
                else {
                    schemaBody[pair[0]] = handleArrayInForm(formData,'attributes');
                }
            }
    
            //POST the new schema to the ledger
            fetch('http://localhost:8021/schemas', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(schemaBody)
            }).then(function (response) {
                return response.text();
            }).then(function (text) {
                console.log(text);
            }).catch(function (error) {
                console.error(error);
            })
        });
    </script>    

</html>